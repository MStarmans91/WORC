

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>WORC.WORC &mdash; WORC 3.3.5 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> WORC
          

          
            
            <img src="../../_static/WORC_Logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.3.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../static/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../static/quick_start.html">Quick start guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../static/user_manual.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../static/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../static/features.html">Radiomics Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../static/additionalfunctionality.html">Additional functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../static/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../static/developerdocumentation.html">Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../static/file_description.html">Resource File Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../static/changelog.html">Changelog</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../autogen/WORC.html">WORC Package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">WORC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>WORC.WORC</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for WORC.WORC</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Copyright 2016-2020 Biomedical Imaging Group Rotterdam, Departments of</span>
<span class="c1"># Medical Informatics and Radiology, Erasmus MC, Rotterdam, The Netherlands</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">fastr</span>
<span class="kn">import</span> <span class="nn">graphviz</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">randint</span>
<span class="kn">import</span> <span class="nn">WORC.IOparser.file_io</span> <span class="k">as</span> <span class="nn">io</span>
<span class="kn">from</span> <span class="nn">fastr.api</span> <span class="k">import</span> <span class="n">ResourceLimit</span>
<span class="kn">from</span> <span class="nn">WORC.tools.Slicer</span> <span class="k">import</span> <span class="n">Slicer</span>
<span class="kn">from</span> <span class="nn">WORC.tools.Elastix</span> <span class="k">import</span> <span class="n">Elastix</span>
<span class="kn">from</span> <span class="nn">WORC.tools.Evaluate</span> <span class="k">import</span> <span class="n">Evaluate</span>
<span class="kn">import</span> <span class="nn">WORC.addexceptions</span> <span class="k">as</span> <span class="nn">WORCexceptions</span>
<span class="kn">import</span> <span class="nn">WORC.IOparser.config_WORC</span> <span class="k">as</span> <span class="nn">config_io</span>
<span class="kn">from</span> <span class="nn">WORC.detectors.detectors</span> <span class="k">import</span> <span class="n">DebugDetector</span>


<div class="viewcode-block" id="WORC"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC">[docs]</a><span class="k">class</span> <span class="nc">WORC</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Workflow for Optimal Radiomics Classification.</span>

<span class="sd">    A Workflow for Optimal Radiomics Classification (WORC) object that</span>
<span class="sd">    serves as a pipeline spawner and manager for optimizating radiomics</span>
<span class="sd">    studies. Depending on the attributes set, the object will spawn an</span>
<span class="sd">    appropriate pipeline and manage it.</span>

<span class="sd">    Note that many attributes are lists and can therefore contain multiple</span>
<span class="sd">    instances. For example, when providing two sequences per patient,</span>
<span class="sd">    the &quot;images&quot; list contains two items. The type of items in the lists</span>
<span class="sd">    is described below.</span>

<span class="sd">    All objects that serve as source for your network, i.e. refer to</span>
<span class="sd">    actual files to be used, should be formatted as fastr sources suited for</span>
<span class="sd">    one of the fastr plugings, see also</span>
<span class="sd">    http://fastr.readthedocs.io/en/stable/fastr.reference.html#ioplugin-reference</span>
<span class="sd">    The objects should be lists of these fastr sources or dictionaries with the</span>
<span class="sd">    sample ID&#39;s, e.g.</span>

<span class="sd">    images_train = [{&#39;Patient001&#39;: vfs://input/CT001.nii.gz,</span>
<span class="sd">                     &#39;Patient002&#39;: vfs://input/CT002.nii.gz},</span>
<span class="sd">                    {&#39;Patient001&#39;: vfs://input/MR001.nii.gz,</span>
<span class="sd">                     &#39;Patient002&#39;: vfs://input/MR002.nii.gz}]</span>

<span class="sd">    Attributes</span>
<span class="sd">    ------------------</span>
<span class="sd">        name: String, default &#39;WORC&#39;</span>
<span class="sd">            name of the network.</span>

<span class="sd">        configs: list, required</span>
<span class="sd">            Configuration parameters, either ConfigParser objects</span>
<span class="sd">            created through the defaultconfig function or paths of config .ini</span>
<span class="sd">            files. (list, required)</span>

<span class="sd">        labels: list, required</span>
<span class="sd">            Paths to files containing patient labels (.txt files).</span>

<span class="sd">        network: automatically generated</span>
<span class="sd">            The FASTR network generated through the &quot;build&quot; function.</span>

<span class="sd">        images: list, optional</span>
<span class="sd">            Paths refering to the images used for Radiomics computation. Images</span>
<span class="sd">            should be of the ITK Image type.</span>

<span class="sd">        segmentations: list, optional</span>
<span class="sd">            Paths refering to the segmentations used for Radiomics computation.</span>
<span class="sd">            Segmentations should be of the ITK Image type.</span>

<span class="sd">        semantics: semantic features per image type (list, optional)</span>

<span class="sd">        masks: state which pixels of images are valid (list, optional)</span>

<span class="sd">        features: input Radiomics features for classification (list, optional)</span>

<span class="sd">        metadata: DICOM headers belonging to images (list, optional)</span>

<span class="sd">        Elastix_Para: parameter files for Elastix (list, optional)</span>

<span class="sd">        fastr_plugin: plugin to use for FASTR execution</span>

<span class="sd">        fastr_tempdir: temporary directory to use for FASTR execution</span>

<span class="sd">        additions: additional inputs for your network (dict, optional)</span>

<span class="sd">        source_data: data to use as sources for FASTR (dict)</span>

<span class="sd">        sink_data: data to use as sinks for FASTR (dict)</span>

<span class="sd">        CopyMetadata: Boolean, default True</span>
<span class="sd">            when using elastix, copy metadata from image to segmentation or not</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WORC.__init__"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize WORC object.</span>

<span class="sd">        Set the initial variables all to None, except for some defaults.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name: name of the nework (string, optional)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;WORC_&#39;</span> <span class="o">+</span> <span class="n">name</span>

        <span class="c1"># Initialize several objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastrconfigs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">images_train</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segmentations_train</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">semantics_train</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels_train</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks_train</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks_normalize_train</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_train</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_train</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">images_test</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segmentations_test</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">semantics_test</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels_test</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks_test</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks_normalize_test</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_test</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_test</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Elastix_Para</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_names</span> <span class="o">=</span> <span class="s1">&#39;Label1, Label2&#39;</span>

        <span class="c1"># Set some defaults, name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastr_plugin</span> <span class="o">=</span> <span class="s1">&#39;LinearExecution&#39;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastr_tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fastr</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mounts</span><span class="p">[</span><span class="s1">&#39;tmp&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">additions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CopyMetadata</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segmode</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_evaluation</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Memory settings for all fastr nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;FeatureCalculator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;14G&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;6G&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;WORCCastConvert&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;4G&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;4G&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;Elastix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;4G&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;Transformix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;4G&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;6G&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;ComBat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;12G&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;PlotEstimator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;12G&#39;</span>

        <span class="k">if</span> <span class="n">DebugDetector</span><span class="p">()</span><span class="o">.</span><span class="n">do_detection</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fastr</span><span class="o">.</span><span class="n">config</span><span class="p">)</span></div>

<div class="viewcode-block" id="WORC.defaultconfig"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.defaultconfig">[docs]</a>    <span class="k">def</span> <span class="nf">defaultconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate a configparser object holding all default configuration values.</span>

<span class="sd">        Returns:</span>
<span class="sd">            config: configparser configuration file</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">optionxform</span> <span class="o">=</span> <span class="nb">str</span>

        <span class="c1"># General configuration of WORC</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;cross_validation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;FeatureCalculators&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[predict/CalcFeatures:1.0, pyradiomics/Pyradiomics:1.0]&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;worc/PreProcess:1.0&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;RegistrationNode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;elastix4.8/Elastix:4.8&quot;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;TransformationNode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;elastix4.8/Transformix:4.8&quot;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;Joblib_ncores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;Joblib_backend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;threading&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;tempsave&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;AssumeSameImageAndMaskMetadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;ComBat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>

        <span class="c1"># Options for the object/patient labels that are used</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Labels&#39;</span><span class="p">][</span><span class="s1">&#39;label_names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Label1, Label2&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Labels&#39;</span><span class="p">][</span><span class="s1">&#39;modus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;singlelabel&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Labels&#39;</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;WIP&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Labels&#39;</span><span class="p">][</span><span class="s1">&#39;projectID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;WIP&#39;</span>

        <span class="c1"># Preprocessing</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;CheckSpacing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;Clipping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;Clipping_Range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-1000.0, 3000.0&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;Normalize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;Normalize_ROI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Full&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;ROIDetermine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Provided&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;ROIdilate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;ROIdilateradius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;10&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;Method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;z_score&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;Resampling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;Resampling_spacing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1, 1, 1&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;BiasCorrection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;BiasCorrection_Mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;CheckOrientation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;OrientationPrimaryAxis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;axial&#39;</span>

        <span class="c1"># Segmentix</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;subtract&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">][</span><span class="s1">&#39;segtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">][</span><span class="s1">&#39;segradius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;5&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">][</span><span class="s1">&#39;N_blobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">][</span><span class="s1">&#39;fillholes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">][</span><span class="s1">&#39;remove_small_objects&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">][</span><span class="s1">&#39;min_object_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>

        <span class="c1"># PREDICT - Feature calculation</span>
        <span class="c1"># Determine which features are calculated</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;histogram&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;texture_Gabor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;texture_LBP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;texture_GLCM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;texture_GLCMMS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;texture_GLRLM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;texture_GLSZM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;texture_NGTDM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;coliage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;vessel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;phase&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>

        <span class="c1"># Parameter settings for PREDICT feature calculation</span>
        <span class="c1"># Defines only naming of modalities</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;image_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CT&#39;</span>

        <span class="c1"># Define frequencies for gabor filter in pixels</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;gabor_frequencies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.05, 0.2, 0.5&#39;</span>

        <span class="c1"># Gabor, GLCM angles in degrees and radians, respectively</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;gabor_angles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0, 45, 90, 135&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;GLCM_angles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0, 0.79, 1.57, 2.36&#39;</span>

        <span class="c1"># GLCM discretization levels, distances in pixels</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;GLCM_levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;16&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;GLCM_distances&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1, 3&#39;</span>

        <span class="c1"># LBP radius, number of points in pixels</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;LBP_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;3, 8, 15&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;LBP_npoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;12, 24, 36&#39;</span>

        <span class="c1"># Phase features minimal wavelength and number of scales</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;phase_minwavelength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;3&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;phase_nscale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;5&#39;</span>

        <span class="c1"># Log features sigma of Gaussian in pixels</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;log_sigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1, 5, 10&#39;</span>

        <span class="c1"># Vessel features scale range, steps for the range</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;vessel_scale_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1, 10&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;vessel_scale_step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>

        <span class="c1"># Vessel features radius for erosion to determine boudnary</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;vessel_radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;5&#39;</span>

        <span class="c1"># Tags from which to extract features, and how to name them</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;dicom_feature_tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0010 1010, 0010 0040&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;dicom_feature_labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;age, sex&#39;</span>

        <span class="c1"># PyRadiomics - Feature calculation</span>
        <span class="c1"># Addition to the above, specifically for PyRadiomics</span>
        <span class="c1"># Mostly based on specific MR Settings: see https://github.com/Radiomics/pyradiomics/blob/master/examples/exampleSettings/exampleMR_NoResampling.yaml</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;geometryTolerance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.0001&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;normalize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;normalizeScale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;100&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;resampledPixelSpacing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;interpolator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sitkBSpline&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;preCrop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;binCount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;GLCM_levels&#39;</span><span class="p">]</span> <span class="c1"># BinWidth to sensitive for normalization, thus use binCount</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;binWidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;force2D&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;force2Ddimension&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>  <span class="c1"># axial slices, for coronal slices, use dimension 1 and for sagittal, dimension 2.</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;voxelArrayShift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;300&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;Original&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;Wavelet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;LoG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>

        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;255&#39;</span>

        <span class="c1"># Enabled PyRadiomics features</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;extract_firstorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;extract_shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;texture_GLCM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;texture_GLRLM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;texture_GLSZM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;texture_GLDM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;PyRadiomics&#39;</span><span class="p">][</span><span class="s1">&#39;texture_NGTDM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>

        <span class="c1"># ComBat Feature Harmonization</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ComBat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ComBat&#39;</span><span class="p">][</span><span class="s1">&#39;language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;python&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ComBat&#39;</span><span class="p">][</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Hospital&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ComBat&#39;</span><span class="p">][</span><span class="s1">&#39;mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;[]&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ComBat&#39;</span><span class="p">][</span><span class="s1">&#39;par&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ComBat&#39;</span><span class="p">][</span><span class="s1">&#39;eb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ComBat&#39;</span><span class="p">][</span><span class="s1">&#39;per_feature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ComBat&#39;</span><span class="p">][</span><span class="s1">&#39;excluded_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sf_, of_, semf_, pf_&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;ComBat&#39;</span><span class="p">][</span><span class="s1">&#39;matlab&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">Program Files</span><span class="se">\\</span><span class="s1">MATLAB</span><span class="se">\\</span><span class="s1">R2015b</span><span class="se">\\</span><span class="s1">bin</span><span class="se">\\</span><span class="s1">matlab.exe&#39;</span>

        <span class="c1"># Feature OneHotEncoding</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;OneHotEncoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;OneHotEncoding&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;OneHotEncoding&#39;</span><span class="p">][</span><span class="s1">&#39;feature_labels_tofit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># Feature imputation</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Imputation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Imputation&#39;</span><span class="p">][</span><span class="s1">&#39;use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Imputation&#39;</span><span class="p">][</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mean, median, most_frequent, constant, knn&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Imputation&#39;</span><span class="p">][</span><span class="s1">&#39;n_neighbors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;5, 5&#39;</span>

        <span class="c1"># Feature scaling options</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;FeatureScaling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;FeatureScaling&#39;</span><span class="p">][</span><span class="s1">&#39;scaling_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;robust_z_score&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;FeatureScaling&#39;</span><span class="p">][</span><span class="s1">&#39;skip_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;semf_, pf_&#39;</span>

        <span class="c1"># Feature preprocessing before all below takes place</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;FeatPreProcess&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;FeatPreProcess&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>

        <span class="c1"># Feature selection</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;Variance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;GroupwiseSearch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;SelectFromModel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.2&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;SelectFromModel_estimator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Lasso&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;SelectFromModel_lasso_alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.1, 1.4&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;SelectFromModel_n_trees&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;10, 90&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;UsePCA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.2&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;PCAType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;95variance, 10, 50, 100&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;StatisticalTestUse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.2&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;StatisticalTestMetric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;MannWhitneyU&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;StatisticalTestThreshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-3, 2.5&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;ReliefUse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.2&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;ReliefNN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2, 4&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;ReliefSampleSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.75, 0.2&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;ReliefDistanceP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1, 3&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Featsel&#39;</span><span class="p">][</span><span class="s1">&#39;ReliefNumFeatures&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;10, 50&#39;</span>

        <span class="c1"># Groupwise Featureselection options</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;shape_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;histogram_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;orientation_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;texture_Gabor_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;texture_GLCM_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;texture_GLDM_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;texture_GLCMMS_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;texture_GLRLM_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;texture_GLSZM_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;texture_GLDZM_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;texture_NGTDM_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;texture_NGLDM_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;texture_LBP_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;dicom_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;semantic_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;coliage_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;vessel_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;phase_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;fractal_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;location_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;rgrd_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>

        <span class="c1"># Select features per toolbox, or simply all</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;toolbox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;All, PREDICT, PyRadiomics&#39;</span>

        <span class="c1"># Select original features, or after transformation of feature space</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;original_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;wavelet_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;SelectFeatGroup&#39;</span><span class="p">][</span><span class="s1">&#39;log_features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True, False&#39;</span>

        <span class="c1"># Resampling options</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Resampling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Resampling&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.20&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Resampling&#39;</span><span class="p">][</span><span class="s1">&#39;Method&#39;</span><span class="p">]</span> <span class="o">=</span>\
            <span class="s1">&#39;RandomUnderSampling, RandomOverSampling, NearMiss, &#39;</span> <span class="o">+</span>\
            <span class="s1">&#39;NeighbourhoodCleaningRule, ADASYN, BorderlineSMOTE, SMOTE, &#39;</span> <span class="o">+</span>\
            <span class="s1">&#39;SMOTEENN, SMOTETomek&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Resampling&#39;</span><span class="p">][</span><span class="s1">&#39;sampling_strategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auto, majority, not minority, not majority, all&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Resampling&#39;</span><span class="p">][</span><span class="s1">&#39;n_neighbors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;3, 12&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Resampling&#39;</span><span class="p">][</span><span class="s1">&#39;k_neighbors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;5, 15&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Resampling&#39;</span><span class="p">][</span><span class="s1">&#39;threshold_cleaning&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.25, 0.5&#39;</span>

        <span class="c1"># Classification</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;fastr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;fastr_plugin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastr_plugin</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;classifiers&#39;</span><span class="p">]</span> <span class="o">=</span>\
            <span class="s1">&#39;SVM, SVM, SVM, SVM, SVM, SVM, SVM, SVM, SVM, &#39;</span> <span class="o">+</span>\
            <span class="s1">&#39;RF, RF, RF, &#39;</span> <span class="o">+</span>\
            <span class="s1">&#39;LR, LR, LR, &#39;</span> <span class="o">+</span>\
            <span class="s1">&#39;LDA, LDA, LDA, &#39;</span> <span class="o">+</span>\
            <span class="s1">&#39;QDA, QDA, QDA, &#39;</span> <span class="o">+</span>\
            <span class="s1">&#39;GaussianNB, GaussianNB, GaussianNB, &#39;</span> <span class="o">+</span>\
            <span class="s1">&#39;AdaBoostClassifier, &#39;</span> <span class="o">+</span>\
            <span class="s1">&#39;XGBClassifier&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;100000&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;SVMKernel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;poly, rbf, linear&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;SVMC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0, 6&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;SVMdegree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1, 6&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;SVMcoef0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0, 1&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;SVMgamma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-5, 5&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;RFn_estimators&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;10, 90&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;RFmin_samples_split&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2, 3&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;RFmax_depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;5, 5&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;LRpenalty&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;l1, l2, elasticnet&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;LRC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.01, 1.0&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;LR_solver&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lbfgs, saga&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;LR_l1_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0, 1&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;LDA_solver&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;svd, lsqr, eigen&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;LDA_shrinkage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-5, 5&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;QDA_reg_param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-5, 5&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;ElasticNet_alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-5, 5&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;ElasticNet_l1_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0, 1&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;SGD_alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-5, 5&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;SGD_l1_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0, 1&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;SGD_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hinge, squared_hinge, modified_huber&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;SGD_penalty&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none, l2, l1&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;CNB_alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0, 1&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;AdaBoost_n_estimators&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;RFn_estimators&#39;</span><span class="p">]</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;AdaBoost_learning_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.01, 0.99&#39;</span>

        <span class="c1"># Based on https://towardsdatascience.com/doing-xgboost-hyper-parameter-tuning-the-smart-way-part-1-of-2-f6d255a45dde</span>
        <span class="c1"># and https://www.analyticsvidhya.com/blog/2016/03/complete-guide-parameter-tuning-xgboost-with-codes-python/</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;XGB_boosting_rounds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;RFn_estimators&#39;</span><span class="p">]</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;XGB_max_depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;3, 12&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;XGB_learning_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;AdaBoost_learning_rate&#39;</span><span class="p">]</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;XGB_gamma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.01, 0.99&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;XGB_min_child_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1, 6&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">][</span><span class="s1">&#39;XGB_colsample_bytree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.3, 0.7&#39;</span>

        <span class="c1"># CrossValidation</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;CrossValidation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;CrossValidation&#39;</span><span class="p">][</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;random_split&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;CrossValidation&#39;</span><span class="p">][</span><span class="s1">&#39;N_iterations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;100&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;CrossValidation&#39;</span><span class="p">][</span><span class="s1">&#39;test_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.2&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;CrossValidation&#39;</span><span class="p">][</span><span class="s1">&#39;fixed_seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>

        <span class="c1"># Hyperparameter optimization options</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;HyperOptimization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;HyperOptimization&#39;</span><span class="p">][</span><span class="s1">&#39;scoring_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;f1_weighted&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;HyperOptimization&#39;</span><span class="p">][</span><span class="s1">&#39;test_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.15&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;HyperOptimization&#39;</span><span class="p">][</span><span class="s1">&#39;n_splits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;5&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;HyperOptimization&#39;</span><span class="p">][</span><span class="s1">&#39;N_iterations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;25000&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;HyperOptimization&#39;</span><span class="p">][</span><span class="s1">&#39;n_jobspercore&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1000&#39;</span>  <span class="c1"># only relevant when using fastr in classification</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;HyperOptimization&#39;</span><span class="p">][</span><span class="s1">&#39;maxlen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;100&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;HyperOptimization&#39;</span><span class="p">][</span><span class="s1">&#39;ranking_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;test_score&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;HyperOptimization&#39;</span><span class="p">][</span><span class="s1">&#39;memory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;3G&#39;</span>

        <span class="c1"># Ensemble options</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Ensemble&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Ensemble&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;50&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Ensemble&#39;</span><span class="p">][</span><span class="s1">&#39;Metric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Default&#39;</span>

        <span class="c1"># Evaluation options</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Evaluation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Evaluation&#39;</span><span class="p">][</span><span class="s1">&#39;OverfitScaler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>

        <span class="c1"># Bootstrap options</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Bootstrap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Bootstrap&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Bootstrap&#39;</span><span class="p">][</span><span class="s1">&#39;N_iterations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1000&#39;</span>

        <span class="k">return</span> <span class="n">config</span></div>

<div class="viewcode-block" id="WORC.add_tools"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.add_tools">[docs]</a>    <span class="k">def</span> <span class="nf">add_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add several tools to the WORC object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Tools</span> <span class="o">=</span> <span class="n">Tools</span><span class="p">()</span></div>

<div class="viewcode-block" id="WORC.build"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wtype</span><span class="o">=</span><span class="s1">&#39;training&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build the  network based on the given attributes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        wtype: string, default &#39;training&#39;</span>
<span class="sd">                Specify the WORC execution type.</span>
<span class="sd">                - testing: use if you have a trained classifier and want to</span>
<span class="sd">                           train it on some new images.</span>
<span class="sd">                - training: use if you want to train a classifier from a dataset.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wtype</span> <span class="o">=</span> <span class="n">wtype</span>
        <span class="k">if</span> <span class="n">wtype</span> <span class="o">==</span> <span class="s1">&#39;training&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_training</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">wtype</span> <span class="o">==</span> <span class="s1">&#39;testing&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_testing</span><span class="p">()</span></div>

<div class="viewcode-block" id="WORC.build_training"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.build_training">[docs]</a>    <span class="k">def</span> <span class="nf">build_training</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build the training network based on the given attributes.&quot;&quot;&quot;</span>
        <span class="c1"># We either need images or features for Radiomics</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_test</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_train</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_train</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Building training network...&#39;</span><span class="p">)</span>
            <span class="c1"># We currently require labels for supervised learning</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_train</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No configuration given, assuming default&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_train</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">configs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">defaultconfig</span><span class="p">()]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images_train</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">configs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">defaultconfig</span><span class="p">()]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_train</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span> <span class="o">=</span> <span class="n">fastr</span><span class="o">.</span><span class="n">create_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="c1"># BUG: We currently use the first configuration as general config</span>
                <span class="n">image_types</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                        <span class="c1"># Probably, c is a configuration file</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_io</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
                    <span class="n">image_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;ImageFeatures&#39;</span><span class="p">][</span><span class="s1">&#39;image_type&#39;</span><span class="p">])</span>

                <span class="c1"># Create config source</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_class_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;ParameterFile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;config_classification_source&#39;</span><span class="p">,</span> <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;conf&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;general_sources&#39;</span><span class="p">)</span>

                <span class="c1"># Classification tool and label source</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_patientclass_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;PatientInfoFile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;patientclass_train&#39;</span><span class="p">,</span> <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;pctrain&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;train_sources&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_test</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source_patientclass_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;PatientInfoFile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;patientclass_test&#39;</span><span class="p">,</span> <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;pctest&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;test_sources&#39;</span><span class="p">)</span>

                <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;Classification&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">classify</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;worc/TrainClassifier:1.0&#39;</span><span class="p">,</span>
                                                         <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
                                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;classify&#39;</span><span class="p">,</span>
                                                         <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;WorkflowOptimization&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">source_Ensemble</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_constant</span><span class="p">(</span><span class="s1">&#39;String&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Ensemble&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]],</span>
                                                 <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;Ensemble&#39;</span><span class="p">,</span>
                                                 <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Evaluation&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_LabelType</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_constant</span><span class="p">(</span><span class="s1">&#39;String&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Labels&#39;</span><span class="p">][</span><span class="s1">&#39;label_names&#39;</span><span class="p">]],</span>
                                                 <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;LabelType&#39;</span><span class="p">,</span>
                                                 <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Evaluation&#39;</span><span class="p">)</span>

                <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;PlotEstimator&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_estimator</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;worc/PlotEstimator:1.0&#39;</span><span class="p">,</span> <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
                                             <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;plot_Estimator&#39;</span><span class="p">,</span>
                                             <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                             <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Evaluation&#39;</span><span class="p">)</span>

                <span class="c1"># Outputs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sink_classification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;HDF5&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;classification&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;general_sinks&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sink_performance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;JsonFile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;performance&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;general_sinks&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sink_class_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;ParameterFile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;config_classification_sink&#39;</span><span class="p">,</span> <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;conf&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;general_sinks&#39;</span><span class="p">)</span>

                <span class="c1"># Links</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sink_class_config</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_class_config</span><span class="o">.</span><span class="n">output</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">link_class_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_class_config</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">link_class_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_patientclass_train</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;patientclass_train&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">link_class_1</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;conf&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">link_class_2</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;pctrain&#39;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">plot_estimator</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;ensemble&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_Ensemble</span><span class="o">.</span><span class="n">output</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_estimator</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;label_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_LabelType</span><span class="o">.</span><span class="n">output</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_test</span><span class="p">:</span>
                    <span class="n">pinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_patientclass_test</span><span class="o">.</span><span class="n">output</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_patientclass_train</span><span class="o">.</span><span class="n">output</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">plot_estimator</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;prediction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;classification&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_estimator</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;pinfo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pinfo</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                    <span class="c1"># FIXME: the naming here is ugly</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">link_class_3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_patientclass_test</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;patientclass_test&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">link_class_3</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;pctest&#39;</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">sink_classification</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;classification&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sink_performance</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_estimator</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;output_json&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_normalize_train</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sources_masks_normalize_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_normalize_test</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sources_masks_normalize_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="c1"># -----------------------------------------------------</span>
                <span class="c1"># Optionally, add ComBat Harmonization. Currently done</span>
                <span class="c1"># on full dataset, not in a cross-validation</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;ComBat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_ComBat</span><span class="p">()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_train</span><span class="p">:</span>
                    <span class="c1"># Create nodes to compute features</span>
                    <span class="c1"># General</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sources_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source_config_pyradiomics</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">source_toolbox_name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                    <span class="c1"># Training only</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">featureconverter_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sources_images_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sinks_features_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">links_C1_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">featurecalculators</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                        <span class="c1"># A test set is supplied, for which nodes also need to be created</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">featureconverter_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sources_images_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sinks_features_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">links_C1_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                    <span class="c1"># Check which nodes are necessary</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentations_train</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;No automatic segmentation method is yet implemented.&quot;</span>
                        <span class="k">raise</span> <span class="n">WORCexceptions</span><span class="o">.</span><span class="n">WORCNotImplementedError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segmentations_train</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_types</span><span class="p">):</span>
                        <span class="c1"># Segmentations provided</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sources_segmentations_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sources_segmentations_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">segmode</span> <span class="o">=</span> <span class="s1">&#39;Provided&#39;</span>

                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segmentations_train</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Assume segmentations need to be registered to other modalities</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - Adding Elastix node for image registration.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_elastix_sourcesandsinks</span><span class="p">()</span>
                        <span class="k">pass</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nseg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segmentations_train</span><span class="p">)</span>
                        <span class="n">nim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_types</span><span class="p">)</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Length of segmentations for training is &#39;</span> <span class="o">+</span>\
                            <span class="n">f</span><span class="s1">&#39;</span><span class="si">{nseg}</span><span class="s1">: should be equal to number of images&#39;</span> <span class="o">+</span>\
                            <span class="n">f</span><span class="s1">&#39; (</span><span class="si">{nim}</span><span class="s1">) or 1 when using registration.&#39;</span>
                        <span class="k">raise</span> <span class="n">WORCexceptions</span><span class="o">.</span><span class="n">WORCValueError</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

                    <span class="c1"># BUG: We assume that first type defines if we use segmentix</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                        <span class="c1"># Use the segmentix toolbox for segmentation processing</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - Adding segmentix node for segmentation preprocessing.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sinks_segmentations_segmentix_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sources_masks_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">converters_masks_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                            <span class="c1"># Also use segmentix on the tes set</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_segmentations_segmentix_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sources_masks_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">converters_masks_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">semantics_train</span><span class="p">:</span>
                        <span class="c1"># Semantic features are supplied</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sources_semantics_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_train</span><span class="p">:</span>
                        <span class="c1"># Metadata to extract patient features from is supplied</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sources_metadata_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">semantics_test</span><span class="p">:</span>
                        <span class="c1"># Semantic features are supplied</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sources_semantics_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_test</span><span class="p">:</span>
                        <span class="c1"># Metadata to extract patient features from is supplied</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sources_metadata_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                    <span class="c1"># Create a part of the pipeline for each modality</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">nmod</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_types</span><span class="p">):</span>
                        <span class="c1"># Create label for each modality/image</span>
                        <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">mod</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
                        <span class="k">while</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_train</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="c1"># if label already exists, add number to label</span>
                            <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="n">mod</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

                        <span class="c1"># Create required sources and sinks</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sources_parameters</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;ParameterFile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;config_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;general_sources&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sources_images_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;images_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;train_sources&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sources_images_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;images_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;test_sources&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_train</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_train</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sources_metadata_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;DicomImageFile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;metadata_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;train_sources&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_test</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_test</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sources_metadata_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;DicomImageFile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;metadata_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;test_sources&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_train</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks_train</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Create mask source and convert</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sources_masks_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;mask_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;train_sources&#39;</span><span class="p">)</span>
                            <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;WORCCastConvert&#39;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">converters_masks_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;worc/WORCCastConvert:0.3.2&#39;</span><span class="p">,</span>
                                                         <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.1&#39;</span><span class="p">,</span>
                                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;convert_mask_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                                         <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                                         <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;FileConversion&#39;</span><span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">converters_masks_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_masks_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_test</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks_test</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Create mask source and convert</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sources_masks_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;mask_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;test_sources&#39;</span><span class="p">)</span>
                            <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;WORCCastConvert&#39;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">converters_masks_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;worc/WORCCastConvert:0.3.2&#39;</span><span class="p">,</span>
                                                         <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.1&#39;</span><span class="p">,</span>
                                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;convert_mask_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                                         <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                         <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;FileConversion&#39;</span><span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">converters_masks_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_masks_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

                        <span class="c1"># First convert the images</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">modality</span> <span class="ow">in</span> <span class="n">mod</span> <span class="k">for</span> <span class="n">modality</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;MR&#39;</span><span class="p">,</span> <span class="s1">&#39;CT&#39;</span><span class="p">,</span> <span class="s1">&#39;MG&#39;</span><span class="p">,</span> <span class="s1">&#39;PET&#39;</span><span class="p">]):</span>
                            <span class="c1"># Use WORC PXCastConvet for converting image formats</span>
                            <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;WORCCastConvert&#39;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;worc/WORCCastConvert:0.3.2&#39;</span><span class="p">,</span>
                                                         <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.1&#39;</span><span class="p">,</span>
                                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;convert_im_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                                         <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;FileConversion&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;worc/WORCCastConvert:0.3.2&#39;</span><span class="p">,</span>
                                                             <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.1&#39;</span><span class="p">,</span>
                                                             <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;convert_im_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                                             <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                                             <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;FileConversion&#39;</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">WORCexceptions</span><span class="o">.</span><span class="n">WORCTypeError</span><span class="p">((</span><span class="s1">&#39;No valid image type for modality </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> provided.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">nmod</span><span class="p">),</span> <span class="n">mod</span><span class="p">))</span>

                        <span class="c1"># Create required links</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_images_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_images_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

                        <span class="c1"># -----------------------------------------------------</span>
                        <span class="c1"># Preprocessing</span>
                        <span class="n">preprocess_node</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">nmod</span><span class="p">][</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">])</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - Adding preprocessing node for image preprocessing.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_preprocessing</span><span class="p">(</span><span class="n">preprocess_node</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">nmod</span><span class="p">)</span>

                        <span class="c1"># -----------------------------------------------------</span>
                        <span class="c1"># Feature calculation</span>
                        <span class="n">feature_calculators</span> <span class="o">=</span>\
                            <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">nmod</span><span class="p">][</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;FeatureCalculators&#39;</span><span class="p">]</span>
                        <span class="n">feature_calculators</span> <span class="o">=</span> <span class="n">feature_calculators</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;][&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">featurecalculators</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_calculators</span><span class="p">]</span>

                        <span class="c1"># Add lists for feature calculation and converter objects</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">featureconverter_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">featureconverter_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

                        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_calculators</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> - Adding feature calculation node: </span><span class="si">{f}</span><span class="s1">.&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_feature_calculator</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">nmod</span><span class="p">)</span>

                        <span class="c1"># -----------------------------------------------------</span>
                        <span class="c1"># Create the neccesary nodes for the segmentation</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmode</span> <span class="o">==</span> <span class="s1">&#39;Provided&#39;</span><span class="p">:</span>
                            <span class="c1"># Segmentation ----------------------------------------------------</span>
                            <span class="c1"># Use the provided segmantions for each modality</span>
                            <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;WORCCastConvert&#39;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sources_segmentations_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span>
                                                           <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;segmentations_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                                           <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                                           <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;train_sources&#39;</span><span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;worc/WORCCastConvert:0.3.2&#39;</span><span class="p">,</span>
                                                         <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.1&#39;</span><span class="p">,</span>
                                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;convert_seg_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                                         <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;FileConversion&#39;</span><span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                                <span class="bp">self</span><span class="o">.</span><span class="n">sources_segmentations_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sources_segmentations_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span>
                                                               <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;segmentations_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                                               <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
                                                               <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;test_sources&#39;</span><span class="p">)</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;worc/WORCCastConvert:0.3.2&#39;</span><span class="p">,</span>
                                                             <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.1&#39;</span><span class="p">,</span>
                                                             <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;convert_seg_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                                             <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                                             <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;FileConversion&#39;</span><span class="p">)</span>

                                <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                                    <span class="bp">self</span><span class="o">.</span><span class="n">sources_segmentations_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmode</span> <span class="o">==</span> <span class="s1">&#39;Register&#39;</span><span class="p">:</span>
                            <span class="c1"># ---------------------------------------------</span>
                            <span class="c1"># Registration nodes: Align segmentation of first</span>
                            <span class="c1"># modality to others using registration ith Elastix</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_elastix</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">nmod</span><span class="p">)</span>

                        <span class="c1"># -----------------------------------------------------</span>
                        <span class="c1"># Optionally, add segmentix, the in-house segmentation</span>
                        <span class="c1"># processor of WORC</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">nmod</span><span class="p">][</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_segmentix</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">nmod</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">nmod</span><span class="p">][</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">][</span><span class="s1">&#39;Resampling&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">WORCexceptions</span><span class="o">.</span><span class="n">WORCValueError</span><span class="p">(</span><span class="s1">&#39;If you use resampling, &#39;</span> <span class="o">+</span>
                                                 <span class="s1">&#39;have to use segmentix to &#39;</span> <span class="o">+</span>
                                                 <span class="s1">&#39; make sure the mask is &#39;</span> <span class="o">+</span>
                                                 <span class="s1">&#39;also resampled. Please &#39;</span> <span class="o">+</span>
                                                 <span class="s1">&#39;set &#39;</span> <span class="o">+</span>
                                                 <span class="s1">&#39;config[&quot;General&quot;][&quot;Segmentix&quot;]&#39;</span> <span class="o">+</span>
                                                 <span class="s1">&#39;to &quot;True&quot;.&#39;</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Provide source or elastix segmentations to</span>
                            <span class="c1"># feature calculator</span>
                            <span class="k">for</span> <span class="n">i_node</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_train</span><span class="p">[</span><span class="n">label</span><span class="p">])):</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmode</span> <span class="o">==</span> <span class="s1">&#39;Provided&#39;</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_train</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation&#39;</span><span class="p">]</span> <span class="o">=</span>\
                                        <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmode</span> <span class="o">==</span> <span class="s1">&#39;Register&#39;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">nmod</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_train</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation&#39;</span><span class="p">]</span> <span class="o">=</span>\
                                            <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_train</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation&#39;</span><span class="p">]</span> <span class="o">=</span>\
                                            <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmode</span> <span class="o">==</span> <span class="s1">&#39;Provided&#39;</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_test</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation&#39;</span><span class="p">]</span> <span class="o">=</span>\
                                            <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmode</span> <span class="o">==</span> <span class="s1">&#39;Register&#39;</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">nmod</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_test</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation&#39;</span><span class="p">]</span> <span class="o">=</span>\
                                                <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_test</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation&#39;</span><span class="p">]</span> <span class="o">=</span>\
                                                <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

                        <span class="c1"># -----------------------------------------------------</span>
                        <span class="c1"># Optionally, add ComBat Harmonization</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;ComBat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                            <span class="c1"># Link features to ComBat</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">links_Combat1_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">i_node</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featurecalculators</span><span class="p">[</span><span class="n">label</span><span class="p">]):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">links_Combat1_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ComBat</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;features_train&#39;</span><span class="p">][</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{label}</span><span class="s1">_</span><span class="si">{self.featurecalculators[label][i_node]}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureconverter_train</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;feat_out&#39;</span><span class="p">])</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">links_Combat1_train</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">links_Combat1_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                                <span class="k">for</span> <span class="n">i_node</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featurecalculators</span><span class="p">[</span><span class="n">label</span><span class="p">]):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">links_Combat1_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ComBat</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;features_test&#39;</span><span class="p">][</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{label}</span><span class="s1">_</span><span class="si">{self.featurecalculators[label][i_node]}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureconverter_test</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;feat_out&#39;</span><span class="p">])</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">links_Combat1_test</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>

                        <span class="c1"># -----------------------------------------------------</span>
                        <span class="c1"># Classification nodes</span>
                        <span class="c1"># Add the features from this modality to the classifier node input</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">links_C1_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sinks_features_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">links_C1_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_features_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

                        <span class="k">for</span> <span class="n">i_node</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featurecalculators</span><span class="p">[</span><span class="n">label</span><span class="p">]):</span>
                            <span class="c1"># Create sink for feature outputs</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_features_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;HDF5&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;features_train_&#39;</span> <span class="o">+</span> <span class="n">label</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">fname</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;train_sinks&#39;</span><span class="p">))</span>

                            <span class="c1"># Append features to the classification</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;ComBat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">links_C1_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;features_train&#39;</span><span class="p">][</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{label}</span><span class="s1">_</span><span class="si">{self.featurecalculators[label][i_node]}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureconverter_train</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;feat_out&#39;</span><span class="p">])</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">links_C1_train</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span>

                            <span class="c1"># Save output</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_features_train</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureconverter_train</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;feat_out&#39;</span><span class="p">]</span>

                            <span class="c1"># Similar for testing workflow</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                                <span class="c1"># Create sink for feature outputs</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sinks_features_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;HDF5&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;features_test_&#39;</span> <span class="o">+</span> <span class="n">label</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">fname</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;test_sinks&#39;</span><span class="p">))</span>

                                <span class="c1"># Append features to the classification</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;ComBat&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">links_C1_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;features_test&#39;</span><span class="p">][</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{label}</span><span class="s1">_</span><span class="si">{self.featurecalculators[label][i_node]}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureconverter_test</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;feat_out&#39;</span><span class="p">])</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">links_C1_test</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>

                                <span class="c1"># Save output</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">sinks_features_test</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">featureconverter_test</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;feat_out&#39;</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Features already provided: hence we can skip numerous nodes</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sources_features_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">links_C1_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_test</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sources_features_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">links_C1_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                    <span class="c1"># Create label for each modality/image</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_types</span><span class="p">):</span>
                        <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">mod</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
                        <span class="k">while</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_features_train</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="c1"># if label exists, add number to label</span>
                            <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">label</span> <span class="o">=</span> <span class="n">mod</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

                        <span class="c1"># Create a node for the feature computation</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sources_features_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;HDF5&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;features_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;train_sources&#39;</span><span class="p">)</span>

                        <span class="c1"># Add the features from this modality to the classifier node input</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">links_C1_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;features_train&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">)]</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_features_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">links_C1_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;train&#39;</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_test</span><span class="p">:</span>
                            <span class="c1"># Create a node for the feature computation</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sources_features_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;HDF5&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;features_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;test_sources&#39;</span><span class="p">)</span>

                            <span class="c1"># Add the features from this modality to the classifier node input</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">links_C1_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;features_test&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">)]</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_features_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">links_C1_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">WORCexceptions</span><span class="o">.</span><span class="n">WORCIOError</span><span class="p">(</span><span class="s2">&quot;Please provide labels.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WORCexceptions</span><span class="o">.</span><span class="n">WORCIOError</span><span class="p">(</span><span class="s2">&quot;Please provide either images or features.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WORC.add_ComBat"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.add_ComBat">[docs]</a>    <span class="k">def</span> <span class="nf">add_ComBat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add ComBat harmonization to the network.</span>

<span class="sd">        Note: applied on all objects, not in a train-test or cross-val setting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;ComBat&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ComBat</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;combat/ComBat:1.0&#39;</span><span class="p">,</span>
                                     <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
                                     <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;ComBat&#39;</span><span class="p">,</span>
                                     <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                     <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;ComBat&#39;</span><span class="p">)</span>

        <span class="c1"># Create sink for ComBat output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinks_features_train_ComBat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;HDF5&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;features_train_ComBat&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;ComBat&#39;</span><span class="p">)</span>

        <span class="c1"># Create links for inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_combat_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_class_config</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ComBat</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_combat_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_patientclass_train</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ComBat</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;patientclass_train&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_combat_1</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;conf&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_combat_2</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;pctrain&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links_Combat1_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links_Combat1_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Link Combat output to both sink and classify node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links_Combat_out_train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ComBat</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;features_train_out&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;features_train&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links_Combat_out_train</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;ComBat&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinks_features_train_ComBat</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ComBat</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;features_train_out&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
            <span class="c1"># Create sink for ComBat output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_features_test_ComBat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;HDF5&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;features_test_ComBat&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;ComBat&#39;</span><span class="p">)</span>

            <span class="c1"># Create links for inputs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">link_combat_3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_patientclass_test</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ComBat</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;patientclass_test&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">link_combat_3</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;pctest&#39;</span>

            <span class="c1"># Link Combat output to both sink and classify node</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_Combat_out_test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ComBat</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;features_test_out&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;features_test&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_Combat_out_test</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;ComBat&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_features_test_ComBat</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ComBat</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;features_test_out&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="WORC.add_preprocessing"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.add_preprocessing">[docs]</a>    <span class="k">def</span> <span class="nf">add_preprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preprocess_node</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">nmod</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add nodes required for preprocessing of images.&quot;&quot;&quot;</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">preprocess_node</span><span class="p">,</span> <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;preprocessing_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">preprocess_node</span><span class="p">,</span> <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;preprocessing_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">)</span>

        <span class="c1"># Create required links</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_parameters</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_parameters</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_train</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_train</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_metadata_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_test</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_test</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_metadata_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

        <span class="c1"># If there are masks to use in normalization, add them here</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_normalize_train</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources_masks_normalize_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;masks_normalize_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_masks_normalize_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_normalize_test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources_masks_normalize_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;masks_normalize_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span> <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_masks_normalize_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span></div>

<div class="viewcode-block" id="WORC.add_feature_calculator"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.add_feature_calculator">[docs]</a>    <span class="k">def</span> <span class="nf">add_feature_calculator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calcfeat_node</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">nmod</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a feature calculation node to the network.&quot;&quot;&quot;</span>
        <span class="c1"># Name of fastr node has to exclude some specific symbols, which</span>
        <span class="c1"># are used in the node name</span>
        <span class="n">node_ID</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">calcfeat_node</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span>
                            <span class="n">label</span><span class="p">])</span>

        <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;FeatureCalculator&#39;</span><span class="p">]</span>
        <span class="n">node_train</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">calcfeat_node</span><span class="p">,</span>
                                     <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
                                     <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;calcfeatures_train_&#39;</span> <span class="o">+</span> <span class="n">node_ID</span><span class="p">,</span>
                                     <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                     <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Feature_Extraction&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
            <span class="n">node_test</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">calcfeat_node</span><span class="p">,</span>
                                         <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;calcfeatures_test_&#39;</span> <span class="o">+</span> <span class="n">node_ID</span><span class="p">,</span>
                                         <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Feature_Extraction&#39;</span><span class="p">)</span>

        <span class="c1"># Check if we need to add pyradiomics specific sources</span>
        <span class="k">if</span> <span class="s1">&#39;pyradiomics&#39;</span> <span class="ow">in</span> <span class="n">calcfeat_node</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="c1"># Add a config source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_config_pyradiomics</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;YamlFile&#39;</span><span class="p">,</span>
                                           <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;config_pyradiomics_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                           <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                           <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Feature_Extraction&#39;</span><span class="p">)</span>

            <span class="c1"># Add a format source, which we are going to set to a constant</span>
            <span class="c1"># And attach to the tool node</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_format_pyradiomics</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_constant</span><span class="p">(</span><span class="s1">&#39;String&#39;</span><span class="p">,</span> <span class="s1">&#39;csv&#39;</span><span class="p">,</span>
                                             <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;format_pyradiomics_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                             <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span>
                                             <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Feature_Extraction&#39;</span><span class="p">)</span>
            <span class="n">node_train</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">source_format_pyradiomics</span><span class="o">.</span><span class="n">output</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                <span class="n">node_test</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">source_format_pyradiomics</span><span class="o">.</span><span class="n">output</span>

        <span class="c1"># Create required links</span>
        <span class="c1"># We can have a different config for different tools</span>
        <span class="k">if</span> <span class="s1">&#39;pyradiomics&#39;</span> <span class="ow">in</span> <span class="n">calcfeat_node</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">node_train</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">source_config_pyradiomics</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node_train</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">sources_parameters</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

        <span class="n">node_train</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;pyradiomics&#39;</span> <span class="ow">in</span> <span class="n">calcfeat_node</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">node_test</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">source_config_pyradiomics</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node_test</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">sources_parameters</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

            <span class="n">node_test</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

        <span class="c1"># PREDICT can extract semantic and metadata features</span>
        <span class="k">if</span> <span class="s1">&#39;predict&#39;</span> <span class="ow">in</span> <span class="n">calcfeat_node</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_train</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_train</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">node_train</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">sources_metadata_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_test</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_test</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">node_test</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">sources_metadata_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

            <span class="c1"># If a semantics file is provided, connect to feature extraction tool</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">semantics_train</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">semantics_train</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources_semantics_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;CSVFile&#39;</span><span class="p">,</span>
                                               <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;semantics_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                               <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;train_sources&#39;</span><span class="p">)</span>

                <span class="n">node_train</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;semantics&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">sources_semantics_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">semantics_test</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">semantics_test</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources_semantics_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;CSVFile&#39;</span><span class="p">,</span>
                                               <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;semantics_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                               <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;test_sources&#39;</span><span class="p">)</span>
                <span class="n">node_test</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;semantics&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">sources_semantics_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

        <span class="c1"># Add feature converter to make features WORC compatible</span>
        <span class="n">conv_train</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;worc/FeatureConverter:1.0&#39;</span><span class="p">,</span>
                                     <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
                                     <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;featureconverter_train_&#39;</span> <span class="o">+</span> <span class="n">node_ID</span><span class="p">,</span>
                                     <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="s1">&#39;4G&#39;</span><span class="p">),</span>
                                     <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Feature_Extraction&#39;</span><span class="p">)</span>

        <span class="n">conv_train</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;feat_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_train</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span>

        <span class="c1"># Add source to tell converter which toolbox we use</span>
        <span class="k">if</span> <span class="s1">&#39;pyradiomics&#39;</span> <span class="ow">in</span> <span class="n">calcfeat_node</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">toolbox</span> <span class="o">=</span> <span class="s1">&#39;PyRadiomics&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;predict&#39;</span> <span class="ow">in</span> <span class="n">calcfeat_node</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">toolbox</span> <span class="o">=</span> <span class="s1">&#39;PREDICT&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Toolbox </span><span class="si">{calcfeat_node}</span><span class="s1"> not recognized!&#39;</span>
            <span class="k">raise</span> <span class="n">WORCexceptions</span><span class="o">.</span><span class="n">WORCKeyError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source_toolbox_name</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_constant</span><span class="p">(</span><span class="s1">&#39;String&#39;</span><span class="p">,</span> <span class="n">toolbox</span><span class="p">,</span>
                                         <span class="nb">id</span><span class="o">=</span><span class="n">f</span><span class="s1">&#39;toolbox_name_</span><span class="si">{toolbox}</span><span class="s1">_</span><span class="si">{label}</span><span class="s1">&#39;</span><span class="p">,</span>
                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Feature_Extraction&#39;</span><span class="p">)</span>

        <span class="n">conv_train</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;toolbox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_toolbox_name</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>
        <span class="n">conv_train</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_parameters</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
            <span class="n">conv_test</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;worc/FeatureConverter:1.0&#39;</span><span class="p">,</span>
                                         <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;featureconverter_test_&#39;</span> <span class="o">+</span> <span class="n">node_ID</span><span class="p">,</span>
                                         <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="s1">&#39;4G&#39;</span><span class="p">),</span>
                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Feature_Extraction&#39;</span><span class="p">)</span>

            <span class="n">conv_test</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;feat_in&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node_test</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span>
            <span class="n">conv_test</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;toolbox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_toolbox_name</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>
            <span class="n">conv_test</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_parameters</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

        <span class="c1"># Append to nodes to list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_train</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featureconverter_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conv_train</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node_test</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">featureconverter_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conv_test</span><span class="p">)</span></div>

<div class="viewcode-block" id="WORC.add_elastix_sourcesandsinks"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.add_elastix_sourcesandsinks">[docs]</a>    <span class="k">def</span> <span class="nf">add_elastix_sourcesandsinks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add sources and sinks required for image registration.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources_segmentation</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">segmode</span> <span class="o">=</span> <span class="s1">&#39;Register&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source_Elastix_Parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources_segmentations_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinks_transformations_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinks_segmentations_elastix_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinks_images_elastix_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edittransformfile_nodes_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformix_im_nodes_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources_segmentations_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinks_transformations_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinks_segmentations_elastix_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinks_images_elastix_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edittransformfile_nodes_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformix_im_nodes_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="WORC.add_elastix"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.add_elastix">[docs]</a>    <span class="k">def</span> <span class="nf">add_elastix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">nmod</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add image registration through elastix to network.&quot;&quot;&quot;</span>
        <span class="c1"># Create sources and converter for only for the given segmentation,</span>
        <span class="c1"># which should be on the first modality</span>
        <span class="k">if</span> <span class="n">nmod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;WORCCastConvert&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sources_segmentations_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span>
                                           <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;segmentations_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                           <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;input&#39;</span><span class="p">,</span>
                                           <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;train_sources&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;worc/WORCCastConvert:0.3.2&#39;</span><span class="p">,</span>
                                         <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.1&#39;</span><span class="p">,</span>
                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;convert_seg_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                         <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;FileConversion&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">sources_segmentations_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sources_segmentations_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span>
                                               <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;segmentations_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                               <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;input&#39;</span><span class="p">,</span>
                                               <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;test_sources&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;worc/WORCCastConvert:0.3.2&#39;</span><span class="p">,</span>
                                             <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.1&#39;</span><span class="p">,</span>
                                             <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;convert_seg_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                             <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                             <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;FileConversion&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">sources_segmentations_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

        <span class="c1"># Assume provided segmentation is on first modality</span>
        <span class="k">if</span> <span class="n">nmod</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Use elastix and transformix for registration</span>
            <span class="c1"># NOTE: Assume elastix node type is on first configuration</span>
            <span class="n">elastix_node</span> <span class="o">=</span>\
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;RegistrationNode&#39;</span><span class="p">])</span>

            <span class="n">transformix_node</span> <span class="o">=</span>\
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;TransformationNode&#39;</span><span class="p">])</span>

            <span class="n">memory_elastix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;Elastix&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">elastix_node</span><span class="p">,</span>
                                         <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.2&#39;</span><span class="p">,</span>
                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;elastix_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                         <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory_elastix</span><span class="p">),</span>
                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Image_Registration&#39;</span><span class="p">)</span>

            <span class="n">memory_transformix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;Elastix&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">transformix_node</span><span class="p">,</span>
                                         <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.2&#39;</span><span class="p">,</span>
                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;transformix_seg_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                         <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory_transformix</span><span class="p">),</span>
                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Image_Registration&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">transformix_im_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">transformix_node</span><span class="p">,</span>
                                         <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.2&#39;</span><span class="p">,</span>
                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;transformix_im_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                         <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory_transformix</span><span class="p">),</span>
                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Image_Registration&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">elastix_node</span><span class="p">,</span>
                                             <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.2&#39;</span><span class="p">,</span>
                                             <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;elastix_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                             <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory_elastix</span><span class="p">),</span>
                                             <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Image_Registration&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">transformix_node</span><span class="p">,</span>
                                             <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.2&#39;</span><span class="p">,</span>
                                             <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;transformix_seg_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                             <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory_transformix</span><span class="p">),</span>
                                             <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Image_Registration&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">transformix_im_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="n">transformix_node</span><span class="p">,</span>
                                             <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.2&#39;</span><span class="p">,</span>
                                             <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;transformix_im_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                             <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory_transformix</span><span class="p">),</span>
                                             <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Image_Registration&#39;</span><span class="p">)</span>

            <span class="c1"># Create sources_segmentation</span>
            <span class="c1"># M1 = moving, others = fixed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;fixed_image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;moving_image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

            <span class="c1"># Add node that copies metadata from the image to the</span>
            <span class="c1"># segmentation if required</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CopyMetadata</span><span class="p">:</span>
                <span class="c1"># Copy metadata from the image which was registered to</span>
                <span class="c1"># the segmentation, if it is not created yet</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;copymetadata_nodes_train&quot;</span><span class="p">):</span>
                    <span class="c1"># NOTE: Do this for first modality, as we assume</span>
                    <span class="c1"># the segmentation is on that one</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">copymetadata_nodes_train</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">copymetadata_nodes_train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;itktools/0.3.2/CopyMetadata:1.0&#39;</span><span class="p">,</span>
                                                 <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
                                                 <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;CopyMetadata_train_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                 <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Image_Registration&#39;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">copymetadata_nodes_train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">copymetadata_nodes_train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="o">=</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">copymetadata_nodes_train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;fixed_image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;moving_image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_test</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CopyMetadata</span><span class="p">:</span>
                    <span class="c1"># Copy metadata from the image which was registered</span>
                    <span class="c1"># to the segmentation</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;copymetadata_nodes_test&quot;</span><span class="p">):</span>
                        <span class="c1"># NOTE: Do this for first modality, as we assume</span>
                        <span class="c1"># the segmentation is on that one</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">copymetadata_nodes_test</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">copymetadata_nodes_test</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span>\
                            <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;itktools/0.3.2/CopyMetadata:1.0&#39;</span><span class="p">,</span>
                                                     <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
                                                     <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;CopyMetadata_test_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                     <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Image_Registration&#39;</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">copymetadata_nodes_test</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span>\
                            <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_test</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">copymetadata_nodes_test</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="o">=</span>\
                            <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_test</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">copymetadata_nodes_test</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_test</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

            <span class="c1"># Apply registration to input modalities</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_Elastix_Parameters</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_source</span><span class="p">(</span><span class="s1">&#39;ElastixParameterFile&#39;</span><span class="p">,</span>
                                           <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;Elastix_Para_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                           <span class="n">node_group</span><span class="o">=</span><span class="s1">&#39;elpara&#39;</span><span class="p">,</span>
                                           <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Image_Registration&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">link_elparam_train</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_Elastix_Parameters</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">link_elparam_train</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;elpara&#39;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">link_elparam_test</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_Elastix_Parameters</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">link_elparam_test</span><span class="o">.</span><span class="n">collapse</span> <span class="o">=</span> <span class="s1">&#39;elpara&#39;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_train</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;fixed_mask&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">converters_masks_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;moving_mask&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">converters_masks_train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_test</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;fixed_mask&#39;</span><span class="p">]</span> <span class="o">=</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">converters_masks_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;moving_mask&#39;</span><span class="p">]</span> <span class="o">=</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">converters_masks_test</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

            <span class="c1"># Change the FinalBSpline Interpolation order to 0 as required for binarie images: see https://github.com/SuperElastix/elastix/wiki/FAQ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edittransformfile_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;elastixtools/EditElastixTransformFile:0.1&#39;</span><span class="p">,</span>
                                         <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.1&#39;</span><span class="p">,</span>
                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;EditElastixTransformFile_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Image_Registration&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">edittransformfile_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="p">[</span><span class="s2">&quot;FinalBSplineInterpolationOrder=0&quot;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">edittransformfile_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">edittransformfile_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;elastixtools/EditElastixTransformFile:0.1&#39;</span><span class="p">,</span>
                                             <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;0.1&#39;</span><span class="p">,</span>
                                             <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;EditElastixTransformFile_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                             <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Image_Registration&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">edittransformfile_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="p">[</span><span class="s2">&quot;FinalBSplineInterpolationOrder=0&quot;</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">edittransformfile_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Link data and transformation to transformix and source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">edittransformfile_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">transformix_im_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">transformix_im_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_train</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">edittransformfile_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">transformix_im_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">transformix_im_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_test</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">[</span><span class="n">nmod</span><span class="p">][</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                <span class="c1"># These segmentations serve as input for the feature calculation</span>
                <span class="k">for</span> <span class="n">i_node</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_train</span><span class="p">[</span><span class="n">label</span><span class="p">])):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_train</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation&#39;</span><span class="p">]</span> <span class="o">=</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_test</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation&#39;</span><span class="p">]</span> <span class="o">=</span>\
                            <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

            <span class="c1"># Save outputfor the training set</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_transformations_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;ElastixTransformFile&#39;</span><span class="p">,</span>
                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;transformations_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;train_sinks&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_segmentations_elastix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span>
                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;segmentations_out_elastix_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;train_sinks&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_images_elastix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span>
                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;images_out_elastix_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;train_sinks&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_transformations_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_segmentations_elastix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_images_elastix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">transformix_im_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

            <span class="c1"># Save output for the test set</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sinks_transformations_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;ElastixTransformFile&#39;</span><span class="p">,</span>
                                             <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;transformations_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                             <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;test_sinks&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">sinks_segmentations_elastix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span>
                                             <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;segmentations_out_elastix_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                             <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;test_sinks&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sinks_images_elastix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span>
                                             <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;images_out_elastix_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                             <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;test_sinks&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sinks_transformations_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">elastix_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;transform&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sinks_segmentations_elastix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sinks_images_elastix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">transformix_im_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="WORC.add_segmentix"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.add_segmentix">[docs]</a>    <span class="k">def</span> <span class="nf">add_segmentix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">nmod</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add segmentix to the network.&quot;&quot;&quot;</span>
        <span class="c1"># Segmentix nodes -------------------------------------------------</span>
        <span class="c1"># Use segmentix node to convert input segmentation into</span>
        <span class="c1"># correct contour</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sinks_segmentations_segmentix_train</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_segmentations_segmentix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span>
                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;segmentations_out_segmentix_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;train_sinks&#39;</span><span class="p">)</span>

        <span class="n">memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastr_memory_parameters</span><span class="p">[</span><span class="s1">&#39;Segmentix&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;segmentix/Segmentix:1.0&#39;</span><span class="p">,</span>
                                     <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
                                     <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;segmentix_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                     <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                     <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">)</span>

        <span class="c1"># Input the image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

        <span class="c1"># Input the metadata</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_train</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_train</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_metadata_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

        <span class="c1"># Input the segmentation</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;transformix_seg_nodes_train&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_train</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c1"># Use output of registration in segmentix</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation_in&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use original segmentation</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation_in&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use original segmentation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation_in&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

        <span class="c1"># Input the parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">sources_parameters</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinks_segmentations_segmentix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;segmentation_out&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_segmentations_segmentix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_sink</span><span class="p">(</span><span class="s1">&#39;ITKImageFile&#39;</span><span class="p">,</span>
                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;segmentations_out_segmentix_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;test_sinks&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">create_node</span><span class="p">(</span><span class="s1">&#39;segmentix/Segmentix:1.0&#39;</span><span class="p">,</span>
                                         <span class="n">tool_version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
                                         <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;segmentix_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">,</span>
                                         <span class="n">resources</span><span class="o">=</span><span class="n">ResourceLimit</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">),</span>
                                         <span class="n">step_id</span><span class="o">=</span><span class="s1">&#39;Preprocessing&#39;</span><span class="p">)</span>

            <span class="c1"># Input the image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">converters_im_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

            <span class="c1"># Input the metadata</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_test</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_test</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources_metadata_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;transformix_seg_nodes_test&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_test</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="c1"># Use output of registration in segmentix</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation_in&#39;</span><span class="p">]</span> <span class="o">=</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">transformix_seg_nodes_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Use original segmentation</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation_in&#39;</span><span class="p">]</span> <span class="o">=</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use original segmentation</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation_in&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">converters_seg_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">sources_parameters</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sinks_segmentations_segmentix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;segmentation_out&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i_node</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_train</span><span class="p">[</span><span class="n">label</span><span class="p">])):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_train</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;segmentation_out&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calcfeatures_test</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">i_node</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;segmentation&#39;</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;segmentation_out&#39;</span><span class="p">]</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_train</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks_train</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Use masks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">converters_masks_train</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_test</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks_test</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">nmod</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Use masks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_segmentix_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">converters_masks_test</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="WORC.set"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the FASTR source and sink data based on the given attributes.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastrconfigs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Save the configurations as files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_config</span><span class="p">()</span>

        <span class="c1"># Generate gridsearch parameter files if required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;config_classification_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastrconfigs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Set source and sink data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;patientclass_train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;patientclass_test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_test</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;classification&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/estimator_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;performance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/performance_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;config_classification_sink&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/config_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;features_train_ComBat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/ComBat/features_ComBat_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;features_test_ComBat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/ComBat/features_ComBat_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Set the source data from the WORC objects you created</span>
        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modlabels</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;config_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastrconfigs</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyradiomics_configs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;config_pyradiomics_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pyradiomics_configs</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="c1"># Add train data sources</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_train</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images_train</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;images_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_train</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_train</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks_train</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;mask_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_train</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_normalize_train</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks_normalize_train</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;masks_normalize_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_normalize_train</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_train</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_train</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;metadata_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_train</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentations_train</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segmentations_train</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;segmentations_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentations_train</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">semantics_train</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">semantics_train</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;semantics_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semantics_train</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_train</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_train</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;features_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_train</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Elastix_Para</span><span class="p">:</span>
                <span class="c1"># First modality does not need to be registered</span>
                <span class="k">if</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Elastix_Para</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Each modality has its own registration parameters</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;Elastix_Para_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Elastix_Para</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Use one fileset for all modalities</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;Elastix_Para_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Elastix_Para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Add test data sources</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_test</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">images_test</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;images_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_test</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_test</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks_test</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;mask_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_test</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_normalize_test</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks_normalize_test</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;masks_normalize_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks_normalize_test</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_test</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_test</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;metadata_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_test</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentations_test</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segmentations_test</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;segmentations_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentations_test</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">semantics_test</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">semantics_test</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;semantics_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">semantics_test</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_test</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features_test</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="o">&gt;=</span> <span class="n">num</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">[</span><span class="s1">&#39;features_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_test</span><span class="p">[</span><span class="n">num</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;segmentations_out_segmentix_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/Segmentations/seg_</span><span class="si">{}</span><span class="s2">_segmentix_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;segmentations_out_elastix_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/Elastix/seg_</span><span class="si">{}</span><span class="s2">_elastix_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;images_out_elastix_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/Elastix/im_</span><span class="si">{}</span><span class="s2">_elastix_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;featurecalculators&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurecalculators</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;features_train_&#39;</span> <span class="o">+</span> <span class="n">label</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/Features/features_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_test</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;segmentations_out_segmentix_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/Segmentations/seg_</span><span class="si">{}</span><span class="s2">_segmentix_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;segmentations_out_elastix_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/Elastix/seg_</span><span class="si">{}</span><span class="s2">_elastix_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;images_out_elastix_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/Images/im_</span><span class="si">{}</span><span class="s2">_elastix_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;featurecalculators&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurecalculators</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;features_test_&#39;</span> <span class="o">+</span> <span class="n">label</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/Features/features_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

            <span class="c1"># Add elastix sinks if used</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmode</span><span class="p">:</span>
                <span class="c1"># Segmode is only non-empty if segmentations are provided</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmode</span> <span class="o">==</span> <span class="s1">&#39;Register&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;transformations_train_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/Elastix/transformation_</span><span class="si">{}</span><span class="s2">_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TrainTest</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">[</span><span class="s1">&#39;transformations_test_&#39;</span> <span class="o">+</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;vfs://output/</span><span class="si">{}</span><span class="s2">/Elastix/transformation_</span><span class="si">{}</span><span class="s2">_{{sample_id}}_{{cardinality}}{{ext}}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_evaluation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Evaluate</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>

<div class="viewcode-block" id="WORC.execute"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute the network through the fastr.network.execute command.&quot;&quot;&quot;</span>
        <span class="c1"># Draw and execute nwtwork</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="s1">&#39;.svg&#39;</span><span class="p">,</span> <span class="n">draw_dimensions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">ExecutableNotFound</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[WORC WARNING] Graphviz executable not found: not drawing network diagram. Make sure the Graphviz executables are on your systems PATH.&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;[WORC WARNING] Graphviz executable gave an error: not drawing network diagram. Original error: </span><span class="si">{e}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">DebugDetector</span><span class="p">()</span><span class="o">.</span><span class="n">do_detection</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Source Data:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> </span><span class="si">{k}</span><span class="s2">: </span><span class="si">{self.source_data[k]}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Sink Data:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> </span><span class="si">{k}</span><span class="s2">: </span><span class="si">{self.sink_data[k]}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="c1"># When debugging, set the tempdir to the default of fastr + name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fastr_tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fastr</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mounts</span><span class="p">[</span><span class="s1">&#39;tmp&#39;</span><span class="p">],</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink_data</span><span class="p">,</span> <span class="n">execution_plugin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fastr_plugin</span><span class="p">,</span> <span class="n">tmpdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fastr_tmpdir</span><span class="p">)</span></div>

<div class="viewcode-block" id="WORC.add_evaluation"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.add_evaluation">[docs]</a>    <span class="k">def</span> <span class="nf">add_evaluation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add branch for evaluation of performance to network.</span>

<span class="sd">        Note: should be done after build, before set:</span>
<span class="sd">        WORC.build()</span>
<span class="sd">        WORC.add_evaluation(label_type)</span>
<span class="sd">        WORC.set()</span>
<span class="sd">        WORC.execute()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Evaluate</span> <span class="o">=</span> <span class="n">Evaluate</span><span class="p">(</span><span class="n">label_type</span><span class="o">=</span><span class="n">label_type</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_evaluation</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="WORC.save_config"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.WORC.save_config">[docs]</a>    <span class="k">def</span> <span class="nf">save_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the config files to physical files and add to network.&quot;&quot;&quot;</span>
        <span class="c1"># If the configuration files are confiparse objects, write to file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pyradiomics_configs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="c1"># Make sure we can dump blank values for PyRadiomics</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">SafeDumper</span><span class="o">.</span><span class="n">add_representer</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                                        <span class="k">lambda</span> <span class="n">dumper</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">dumper</span><span class="o">.</span><span class="n">represent_scalar</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;tag:yaml.org,2002:null&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configs</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">:</span>
                <span class="c1"># A filepath (not a fastr source) is provided. Hence we read</span>
                <span class="c1"># the config file and convert it to a configparser object</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
                <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">config</span>
            <span class="n">cfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastr_tmpdir</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;config_</span><span class="si">{self.name}</span><span class="s2">_</span><span class="si">{num}</span><span class="s2">.ini&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">cfile</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">cfile</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">configfile</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">configfile</span><span class="p">)</span>

            <span class="c1"># If PyRadiomics is used, also write a config for PyRadiomics</span>
            <span class="k">if</span> <span class="s1">&#39;pyradiomics&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;General&#39;</span><span class="p">][</span><span class="s1">&#39;FeatureCalculators&#39;</span><span class="p">]:</span>
                <span class="n">cfile_pyradiomics</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastr_tmpdir</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;config_pyradiomics_</span><span class="si">{self.name}</span><span class="s2">_</span><span class="si">{num}</span><span class="s2">.yaml&quot;</span><span class="p">)</span>
                <span class="n">config_pyradiomics</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">convert_config_pyradiomics</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfile_pyradiomics</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">config_pyradiomics</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="n">cfile_pyradiomics</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastr_tmpdir</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="s2">&quot;config_pyradiomics_</span><span class="si">{self.name}</span><span class="s2">_</span><span class="si">{num}</span><span class="s2">.yaml&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pyradiomics_configs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cfile_pyradiomics</span><span class="o">.</span><span class="n">as_uri</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%20&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>

            <span class="c1"># BUG: Make path with pathlib to create windows double slashes</span>
            <span class="n">cfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastr_tmpdir</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="s2">&quot;config_</span><span class="si">{self.name}</span><span class="s2">_</span><span class="si">{num}</span><span class="s2">.ini&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fastrconfigs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cfile</span><span class="o">.</span><span class="n">as_uri</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%20&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="Tools"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.Tools">[docs]</a><span class="k">class</span> <span class="nc">Tools</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create other pipelines besides the default radiomics executions.</span>

<span class="sd">    Currently includes:</span>
<span class="sd">    1. Registration pipeline</span>
<span class="sd">    2. Evaluation pipeline</span>
<span class="sd">    3. Slicer pipeline, to create pngs of middle slice of images.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Tools.__init__"><a class="viewcode-back" href="../../autogen/WORC.html#WORC.WORC.Tools.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize object with all pipelines.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Elastix</span> <span class="o">=</span> <span class="n">Elastix</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Evaluate</span> <span class="o">=</span> <span class="n">Evaluate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Slicer</span> <span class="o">=</span> <span class="n">Slicer</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016 -- 2020, Biomedical Imaging Group Rotterdam, Departments of Medical Informatics and Radiology, Erasmus MC, Rotterdam, The Netherlands

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>